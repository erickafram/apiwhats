#!/usr/bin/env node

const path = require('path');
process.env.NODE_ENV = 'production';

console.log('üîß CORRIGINDO PROBLEMA DE FLUXOS EM PRODU√á√ÉO');
console.log('============================================\n');

async function fixFlowIssue() {
  try {
    const { sequelize, Bot, Flow, Conversation } = require('./src/models');
    
    // 1. Verificar conex√£o com banco
    console.log('1Ô∏è‚É£ Conectando ao banco de dados...');
    await sequelize.authenticate();
    console.log('   ‚úÖ Conex√£o estabelecida');

    // 2. Verificar bots existentes
    console.log('\n2Ô∏è‚É£ Verificando bots...');
    const bots = await Bot.findAll();
    if (bots.length === 0) {
      console.log('   ‚ùå Nenhum bot encontrado. Criando bot padr√£o...');
      
      const defaultBot = await Bot.create({
        name: 'Auto Mec√¢nica',
        phone_number: '5511999999999',
        status: 'active',
        user_id: 1,
        settings: JSON.stringify({
          welcome_message: 'Ol√°! Como posso ajud√°-lo?',
          business_hours: '08:00-18:00',
          auto_response: true
        })
      });
      
      console.log(`   ‚úÖ Bot criado: ${defaultBot.name} (ID: ${defaultBot.id})`);
      bots.push(defaultBot);
    } else {
      console.log(`   ‚úÖ ${bots.length} bot(s) encontrado(s)`);
      for (const bot of bots) {
        console.log(`      - ${bot.name} (ID: ${bot.id}, Status: ${bot.status})`);
      }
    }

    // 3. Verificar fluxos ativos
    console.log('\n3Ô∏è‚É£ Verificando fluxos ativos...');
    const activeFlows = await Flow.findAll({
      where: { is_active: true }
    });

    if (activeFlows.length === 0) {
      console.log('   ‚ùå PROBLEMA IDENTIFICADO: Nenhum fluxo ativo!');
      console.log('   üîß Criando fluxo padr√£o...');

      // Criar fluxo padr√£o funcional
      const defaultFlowData = {
        nodes: [
          {
            id: 'start',
            type: 'start',
            position: { x: 100, y: 100 },
            next: 'welcome'
          },
          {
            id: 'welcome',
            type: 'message',
            content: `üëã Ol√°! Bem-vindo √† Auto Mec√¢nica!

Como posso ajud√°-lo hoje?

1Ô∏è‚É£ Servi√ßos dispon√≠veis
2Ô∏è‚É£ Or√ßamento
3Ô∏è‚É£ Agendamento
4Ô∏è‚É£ Contato
5Ô∏è‚É£ Localiza√ß√£o

Digite o n√∫mero da op√ß√£o desejada:`,
            position: { x: 100, y: 200 },
            next: 'menu_input'
          },
          {
            id: 'menu_input',
            type: 'input',
            variable: 'menu_option',
            position: { x: 100, y: 300 },
            next: 'menu_condition'
          },
          {
            id: 'menu_condition',
            type: 'condition',
            position: { x: 100, y: 400 },
            conditions: [
              {
                value: '1',
                operator: 'equals',
                variable: 'menu_option',
                next: 'servicos'
              },
              {
                value: '2',
                operator: 'equals',
                variable: 'menu_option',
                next: 'orcamento'
              },
              {
                value: '3',
                operator: 'equals',
                variable: 'menu_option',
                next: 'agendamento'
              },
              {
                value: '4',
                operator: 'equals',
                variable: 'menu_option',
                next: 'contato'
              },
              {
                value: '5',
                operator: 'equals',
                variable: 'menu_option',
                next: 'localizacao'
              }
            ],
            default_next: 'opcao_invalida'
          },
          {
            id: 'servicos',
            type: 'message',
            content: `üîß Nossos Servi√ßos:

‚Ä¢ Troca de √≥leo e filtros
‚Ä¢ Revis√£o completa
‚Ä¢ Freios e suspens√£o
‚Ä¢ Sistema el√©trico
‚Ä¢ Ar condicionado
‚Ä¢ Diagn√≥stico computadorizado

Digite "menu" para voltar ao menu principal.`,
            position: { x: 300, y: 300 },
            next: 'end'
          },
          {
            id: 'orcamento',
            type: 'message',
            content: `üí∞ Or√ßamento Gratuito!

Para um or√ßamento personalizado, preciso de algumas informa√ß√µes:

‚Ä¢ Modelo do ve√≠culo
‚Ä¢ Ano
‚Ä¢ Problema/servi√ßo desejado

Fale com nosso atendente: (11) 99999-9999

Digite "menu" para voltar ao menu principal.`,
            position: { x: 500, y: 300 },
            next: 'end'
          },
          {
            id: 'agendamento',
            type: 'message',
            content: `üìÖ Agendamento

Hor√°rio de funcionamento:
Segunda a Sexta: 8h √†s 18h
S√°bado: 8h √†s 12h

Para agendar, ligue: (11) 99999-9999
Ou envie WhatsApp: (11) 99999-9999

Digite "menu" para voltar ao menu principal.`,
            position: { x: 700, y: 300 },
            next: 'end'
          },
          {
            id: 'contato',
            type: 'message',
            content: `üìû Nossos Contatos:

Telefone: (11) 99999-9999
WhatsApp: (11) 99999-9999
Email: contato@automecanica.com

Hor√°rio de atendimento:
Segunda a Sexta: 8h √†s 18h
S√°bado: 8h √†s 12h

Digite "menu" para voltar ao menu principal.`,
            position: { x: 900, y: 300 },
            next: 'end'
          },
          {
            id: 'localizacao',
            type: 'message',
            content: `üìç Nossa Localiza√ß√£o:

Auto Mec√¢nica Silva
Rua das Oficinas, 123
Centro - S√£o Paulo/SP
CEP: 01234-567

üöó Estacionamento gratuito
üöå Pr√≥ximo ao metr√¥

Digite "menu" para voltar ao menu principal.`,
            position: { x: 1100, y: 300 },
            next: 'end'
          },
          {
            id: 'opcao_invalida',
            type: 'message',
            content: `‚ùå Op√ß√£o inv√°lida!

Por favor, digite apenas o n√∫mero da op√ß√£o desejada (1 a 5).

Digite "menu" para ver as op√ß√µes novamente.`,
            position: { x: 100, y: 600 },
            next: 'end'
          },
          {
            id: 'end',
            type: 'end',
            position: { x: 100, y: 700 }
          }
        ],
        edges: [
          { source: 'start', target: 'welcome' },
          { source: 'welcome', target: 'menu_input' },
          { source: 'menu_input', target: 'menu_condition' },
          { source: 'menu_condition', target: 'servicos' },
          { source: 'menu_condition', target: 'orcamento' },
          { source: 'menu_condition', target: 'agendamento' },
          { source: 'menu_condition', target: 'contato' },
          { source: 'menu_condition', target: 'localizacao' },
          { source: 'menu_condition', target: 'opcao_invalida' },
          { source: 'servicos', target: 'end' },
          { source: 'orcamento', target: 'end' },
          { source: 'agendamento', target: 'end' },
          { source: 'contato', target: 'end' },
          { source: 'localizacao', target: 'end' },
          { source: 'opcao_invalida', target: 'end' }
        ],
        viewport: { x: 0, y: 0, zoom: 1 }
      };

      const defaultFlow = await Flow.create({
        name: 'Menu Principal - Auto Mec√¢nica',
        description: 'Fluxo principal com menu de op√ß√µes para auto mec√¢nica',
        bot_id: bots[0].id,
        trigger_keywords: JSON.stringify(['oi', 'ol√°', 'menu', 'in√≠cio', 'start', 'ola', 'hello']),
        is_active: true,
        is_default: true,
        priority: 10,
        flow_data: JSON.stringify(defaultFlowData)
      });

      console.log(`   ‚úÖ Fluxo padr√£o criado: ${defaultFlow.name} (ID: ${defaultFlow.id})`);

    } else {
      console.log(`   ‚úÖ ${activeFlows.length} fluxo(s) ativo(s) encontrado(s)`);
      
      // Verificar se os fluxos t√™m trigger_keywords
      for (const flow of activeFlows) {
        let triggerKeywords = [];
        try {
          triggerKeywords = JSON.parse(flow.trigger_keywords || '[]');
        } catch (e) {
          triggerKeywords = [];
        }

        if (triggerKeywords.length === 0) {
          console.log(`   ‚ö†Ô∏è Fluxo "${flow.name}" sem palavras-chave. Adicionando...`);
          await flow.update({
            trigger_keywords: JSON.stringify(['oi', 'ol√°', 'menu', 'in√≠cio', 'start', 'ola'])
          });
          console.log(`   ‚úÖ Palavras-chave adicionadas ao fluxo "${flow.name}"`);
        }
      }
    }

    // 4. Verificar e corrigir configura√ß√£o do bot
    console.log('\n4Ô∏è‚É£ Verificando configura√ß√£o dos bots...');
    for (const bot of bots) {
      if (bot.status !== 'active') {
        console.log(`   üîß Ativando bot "${bot.name}"...`);
        await bot.update({ status: 'active' });
      }

      // Verificar se tem configura√ß√µes b√°sicas
      let settings = {};
      try {
        settings = JSON.parse(bot.settings || '{}');
      } catch (e) {
        settings = {};
      }

      if (!settings.welcome_message) {
        settings.welcome_message = 'Ol√°! Como posso ajud√°-lo?';
        settings.auto_response = true;
        settings.business_hours = '08:00-18:00';
        
        await bot.update({
          settings: JSON.stringify(settings)
        });
        
        console.log(`   ‚úÖ Configura√ß√µes b√°sicas adicionadas ao bot "${bot.name}"`);
      }
    }

    // 5. Testar processamento
    console.log('\n5Ô∏è‚É£ Testando processamento de mensagem...');
    try {
      const MaytapiFlowProcessor = require('./src/services/MaytapiFlowProcessor');
      const MaytapiService = require('./src/services/MaytapiService');
      
      const maytapiService = new MaytapiService();
      console.log('   ‚úÖ MaytapiService inicializado');

      // Simular processamento
      const testResult = await maytapiService.flowProcessor.processMessage(
        bots[0].id,
        '5511999999999',
        'menu',
        'text'
      );

      if (testResult && testResult.success) {
        console.log('   ‚úÖ Teste de processamento bem-sucedido');
      } else {
        console.log('   ‚ö†Ô∏è Teste de processamento com problemas:', testResult?.error || 'Erro desconhecido');
      }

    } catch (testError) {
      console.log(`   ‚ùå Erro no teste: ${testError.message}`);
    }

    console.log('\n‚úÖ CORRE√á√ÉO CONCLU√çDA!');
    console.log('\nüìã Resumo das a√ß√µes:');
    console.log('   ‚Ä¢ Verifica√ß√£o de bots e fluxos');
    console.log('   ‚Ä¢ Cria√ß√£o de fluxo padr√£o (se necess√°rio)');
    console.log('   ‚Ä¢ Configura√ß√£o de palavras-chave');
    console.log('   ‚Ä¢ Ativa√ß√£o de bots');
    console.log('   ‚Ä¢ Teste de processamento');
    
    console.log('\nüöÄ Pr√≥ximos passos:');
    console.log('   1. Reinicie o PM2: pm2 restart chatbot-whats-api');
    console.log('   2. Teste enviando "menu" para o WhatsApp');
    console.log('   3. Verifique os logs: pm2 logs chatbot-whats-api');

  } catch (error) {
    console.error('‚ùå Erro durante corre√ß√£o:', error);
    console.error('Stack trace:', error.stack);
    process.exit(1);
  }
}

// Executar corre√ß√£o
fixFlowIssue().then(() => {
  console.log('\nüéâ Corre√ß√£o finalizada com sucesso!');
  process.exit(0);
}).catch((error) => {
  console.error('‚ùå Erro fatal:', error);
  process.exit(1);
});
