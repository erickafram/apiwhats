class FlowTemplateService {
  constructor() {
    this.templates = new Map();
    this.initializeTemplates();
  }

  initializeTemplates() {
    // Template: Atendimento ao Cliente
    this.templates.set('customer_service', {
      id: 'customer_service',
      name: 'Atendimento ao Cliente',
      description: 'Fluxo completo para atendimento ao cliente com op√ß√µes de produtos, suporte e transfer√™ncia',
      category: 'atendimento',
      tags: ['atendimento', 'suporte', 'produtos'],
      flow_data: {
        nodes: [
          {
            id: 'start_1',
            type: 'start',
            position: { x: 100, y: 100 },
            data: {
              message: 'üëã Ol√°! Bem-vindo ao nosso atendimento!\n\nComo posso ajud√°-lo hoje?\n\n1Ô∏è‚É£ Informa√ß√µes sobre produtos\n2Ô∏è‚É£ Suporte t√©cnico\n3Ô∏è‚É£ Falar com atendente\n4Ô∏è‚É£ Outras d√∫vidas'
            }
          },
          {
            id: 'menu_condition',
            type: 'condition',
            position: { x: 100, y: 250 },
            data: {
              conditions: [
                { field: 'message_content', operator: 'contains', value: '1' }
              ],
              operator: 'OR'
            }
          },
          {
            id: 'products_info',
            type: 'fixed_response',
            position: { x: 300, y: 200 },
            data: {
              message: 'üì¶ Informa√ß√µes sobre Produtos\n\nTemos uma ampla gama de produtos dispon√≠veis:\n\n‚Ä¢ Categoria A\n‚Ä¢ Categoria B\n‚Ä¢ Categoria C\n\nGostaria de saber mais sobre alguma categoria espec√≠fica?',
              delay: 1000
            }
          },
          {
            id: 'support_condition',
            type: 'condition',
            position: { x: 100, y: 400 },
            data: {
              conditions: [
                { field: 'message_content', operator: 'contains', value: '2' }
              ]
            }
          },
          {
            id: 'technical_support',
            type: 'ai_response',
            position: { x: 300, y: 350 },
            data: {
              system_prompt: 'Voc√™ √© um especialista em suporte t√©cnico. Ajude o usu√°rio com problemas t√©cnicos de forma clara e did√°tica.',
              temperature: 0.5,
              max_tokens: 500
            }
          },
          {
            id: 'human_condition',
            type: 'condition',
            position: { x: 100, y: 550 },
            data: {
              conditions: [
                { field: 'message_content', operator: 'contains', value: '3' }
              ]
            }
          },
          {
            id: 'transfer_human',
            type: 'transfer_human',
            position: { x: 300, y: 500 },
            data: {
              message: 'üë®‚Äçüíº Transferindo voc√™ para um de nossos atendentes...\n\nEm breve algu√©m entrar√° em contato!',
              department: 'support'
            }
          },
          {
            id: 'ai_general',
            type: 'ai_response',
            position: { x: 100, y: 700 },
            data: {
              system_prompt: 'Voc√™ √© um assistente de atendimento ao cliente. Responda de forma √∫til e educada sobre d√∫vidas gerais.',
              temperature: 0.7,
              max_tokens: 800
            }
          }
        ],
        edges: [
          { id: 'e1', source: 'start_1', target: 'menu_condition' },
          { id: 'e2', source: 'menu_condition', target: 'products_info', sourceHandle: 'true' },
          { id: 'e3', source: 'menu_condition', target: 'support_condition', sourceHandle: 'false' },
          { id: 'e4', source: 'support_condition', target: 'technical_support', sourceHandle: 'true' },
          { id: 'e5', source: 'support_condition', target: 'human_condition', sourceHandle: 'false' },
          { id: 'e6', source: 'human_condition', target: 'transfer_human', sourceHandle: 'true' },
          { id: 'e7', source: 'human_condition', target: 'ai_general', sourceHandle: 'false' }
        ],
        viewport: { x: 0, y: 0, zoom: 1 }
      },
      trigger_keywords: ['oi', 'ol√°', 'hello', 'help', 'ajuda', 'in√≠cio'],
      variables: [
        { name: 'user_name', type: 'string', description: 'Nome do usu√°rio' },
        { name: 'user_email', type: 'email', description: 'Email do usu√°rio' },
        { name: 'issue_type', type: 'string', description: 'Tipo do problema' }
      ]
    });

    // Template: Lead Qualification
    this.templates.set('lead_qualification', {
      id: 'lead_qualification',
      name: 'Qualifica√ß√£o de Leads',
      description: 'Fluxo para qualificar leads e coletar informa√ß√µes importantes',
      category: 'vendas',
      tags: ['vendas', 'leads', 'qualifica√ß√£o'],
      flow_data: {
        nodes: [
          {
            id: 'start_lead',
            type: 'start',
            position: { x: 100, y: 100 },
            data: {
              message: 'üéØ Ol√°! Que bom ter voc√™ aqui!\n\nPara oferecer a melhor solu√ß√£o, preciso conhecer um pouco sobre voc√™.\n\nQual √© o seu nome?'
            }
          },
          {
            id: 'capture_name',
            type: 'input_capture',
            position: { x: 100, y: 250 },
            data: {
              variable_name: 'user_name',
              input_type: 'text',
              validation: { required: true, min_length: 2 },
              retry_message: 'Por favor, digite seu nome completo.'
            }
          },
          {
            id: 'ask_company',
            type: 'fixed_response',
            position: { x: 100, y: 400 },
            data: {
              message: 'Prazer em conhec√™-lo, {{user_name}}! üòä\n\nEm qual empresa voc√™ trabalha?'
            }
          },
          {
            id: 'capture_company',
            type: 'input_capture',
            position: { x: 100, y: 550 },
            data: {
              variable_name: 'company',
              input_type: 'text',
              validation: { required: true, min_length: 2 }
            }
          },
          {
            id: 'ask_role',
            type: 'fixed_response',
            position: { x: 100, y: 700 },
            data: {
              message: 'Perfeito! E qual √© o seu cargo na {{company}}?'
            }
          },
          {
            id: 'capture_role',
            type: 'input_capture',
            position: { x: 100, y: 850 },
            data: {
              variable_name: 'role',
              input_type: 'text',
              validation: { required: true }
            }
          },
          {
            id: 'qualification_complete',
            type: 'fixed_response',
            position: { x: 100, y: 1000 },
            data: {
              message: 'Excelente, {{user_name}}! üéâ\n\nAgora que conhe√ßo seu perfil, posso apresentar as melhores solu√ß√µes para a {{company}}.\n\nUm especialista entrar√° em contato em breve!'
            }
          },
          {
            id: 'send_to_crm',
            type: 'webhook',
            position: { x: 300, y: 1000 },
            data: {
              url: 'https://api.crm.com/leads',
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: {
                name: '{{user_name}}',
                company: '{{company}}',
                role: '{{role}}',
                source: 'whatsapp_bot'
              }
            }
          }
        ],
        edges: [
          { id: 'e1', source: 'start_lead', target: 'capture_name' },
          { id: 'e2', source: 'capture_name', target: 'ask_company' },
          { id: 'e3', source: 'ask_company', target: 'capture_company' },
          { id: 'e4', source: 'capture_company', target: 'ask_role' },
          { id: 'e5', source: 'ask_role', target: 'capture_role' },
          { id: 'e6', source: 'capture_role', target: 'qualification_complete' },
          { id: 'e7', source: 'qualification_complete', target: 'send_to_crm' }
        ],
        viewport: { x: 0, y: 0, zoom: 1 }
      },
      trigger_keywords: ['vendas', 'produto', 'solu√ß√£o', 'or√ßamento'],
      variables: [
        { name: 'user_name', type: 'string', description: 'Nome completo do lead' },
        { name: 'company', type: 'string', description: 'Empresa do lead' },
        { name: 'role', type: 'string', description: 'Cargo do lead' },
        { name: 'phone', type: 'phone', description: 'Telefone do lead' }
      ]
    });

    // Template: FAQ Autom√°tico
    this.templates.set('faq_bot', {
      id: 'faq_bot',
      name: 'FAQ Autom√°tico',
      description: 'Bot para responder perguntas frequentes automaticamente',
      category: 'suporte',
      tags: ['faq', 'perguntas', 'autom√°tico'],
      flow_data: {
        nodes: [
          {
            id: 'faq_start',
            type: 'start',
            position: { x: 100, y: 100 },
            data: {
              message: '‚ùì Central de Perguntas Frequentes\n\nEscolha uma categoria:\n\n1Ô∏è‚É£ Hor√°rio de funcionamento\n2Ô∏è‚É£ Formas de pagamento\n3Ô∏è‚É£ Pol√≠tica de devolu√ß√£o\n4Ô∏è‚É£ Entrega e frete\n5Ô∏è‚É£ Falar com atendente'
            }
          },
          {
            id: 'faq_router',
            type: 'condition',
            position: { x: 100, y: 250 },
            data: {
              conditions: [
                { field: 'message_content', operator: 'contains', value: '1' },
                { field: 'message_content', operator: 'contains', value: 'hor√°rio' },
                { field: 'message_content', operator: 'contains', value: 'funcionamento' }
              ],
              operator: 'OR'
            }
          },
          {
            id: 'hours_info',
            type: 'fixed_response',
            position: { x: 300, y: 200 },
            data: {
              message: 'üïí Hor√°rio de Funcionamento\n\nüìÖ Segunda a Sexta: 9h √†s 18h\nüìÖ S√°bado: 9h √†s 12h\nüìÖ Domingo: Fechado\n\nü§ñ Atendimento online 24h via chatbot!\n\nPrecisa de mais alguma coisa?'
            }
          },
          {
            id: 'payment_condition',
            type: 'condition',
            position: { x: 100, y: 400 },
            data: {
              conditions: [
                { field: 'message_content', operator: 'contains', value: '2' },
                { field: 'message_content', operator: 'contains', value: 'pagamento' }
              ],
              operator: 'OR'
            }
          },
          {
            id: 'payment_info',
            type: 'fixed_response',
            position: { x: 300, y: 350 },
            data: {
              message: 'üí≥ Formas de Pagamento\n\n‚úÖ Cart√£o de cr√©dito (at√© 12x)\n‚úÖ Cart√£o de d√©bito\n‚úÖ PIX (5% desconto)\n‚úÖ Boleto banc√°rio\n‚úÖ Transfer√™ncia banc√°ria\n\nTodas as transa√ß√µes s√£o seguras e criptografadas! üîí'
            }
          },
          {
            id: 'ai_fallback',
            type: 'ai_response',
            position: { x: 100, y: 600 },
            data: {
              system_prompt: 'Voc√™ √© um assistente de FAQ. Responda perguntas sobre hor√°rios, pagamentos, devolu√ß√µes e entregas de forma clara e objetiva.',
              temperature: 0.3,
              max_tokens: 300
            }
          }
        ],
        edges: [
          { id: 'e1', source: 'faq_start', target: 'faq_router' },
          { id: 'e2', source: 'faq_router', target: 'hours_info', sourceHandle: 'true' },
          { id: 'e3', source: 'faq_router', target: 'payment_condition', sourceHandle: 'false' },
          { id: 'e4', source: 'payment_condition', target: 'payment_info', sourceHandle: 'true' },
          { id: 'e5', source: 'payment_condition', target: 'ai_fallback', sourceHandle: 'false' }
        ],
        viewport: { x: 0, y: 0, zoom: 1 }
      },
      trigger_keywords: ['faq', 'd√∫vidas', 'perguntas', 'hor√°rio', 'pagamento'],
      variables: []
    });

    console.log(`‚úÖ ${this.templates.size} templates de fluxo carregados`);
  }

  getAllTemplates() {
    return Array.from(this.templates.values());
  }

  getTemplatesByCategory(category) {
    return Array.from(this.templates.values()).filter(template => 
      template.category === category
    );
  }

  getTemplateById(id) {
    return this.templates.get(id);
  }

  searchTemplates(query) {
    const searchTerm = query.toLowerCase();
    return Array.from(this.templates.values()).filter(template => 
      template.name.toLowerCase().includes(searchTerm) ||
      template.description.toLowerCase().includes(searchTerm) ||
      template.tags.some(tag => tag.toLowerCase().includes(searchTerm))
    );
  }

  createFlowFromTemplate(templateId, customizations = {}) {
    const template = this.getTemplateById(templateId);
    if (!template) {
      throw new Error(`Template ${templateId} n√£o encontrado`);
    }

    // Clonar template
    const flowData = JSON.parse(JSON.stringify(template.flow_data));
    
    // Aplicar customiza√ß√µes
    if (customizations.name) {
      // Personalizar nome nos n√≥s se necess√°rio
    }

    if (customizations.variables) {
      // Substituir vari√°veis nos n√≥s
      this.replaceVariables(flowData, customizations.variables);
    }

    return {
      name: customizations.name || template.name,
      description: customizations.description || template.description,
      flow_data: flowData,
      trigger_keywords: customizations.trigger_keywords || template.trigger_keywords,
      is_active: customizations.is_active !== undefined ? customizations.is_active : true,
      is_default: customizations.is_default || false,
      template_id: templateId
    };
  }

  replaceVariables(flowData, variables) {
    const replaceInString = (str) => {
      let result = str;
      Object.keys(variables).forEach(key => {
        const regex = new RegExp(`{{${key}}}`, 'g');
        result = result.replace(regex, variables[key]);
      });
      return result;
    };

    // Substituir vari√°veis em todos os n√≥s
    flowData.nodes.forEach(node => {
      if (node.data && node.data.message) {
        node.data.message = replaceInString(node.data.message);
      }
      if (node.data && node.data.system_prompt) {
        node.data.system_prompt = replaceInString(node.data.system_prompt);
      }
    });
  }

  getCategories() {
    const categories = new Set();
    this.templates.forEach(template => {
      categories.add(template.category);
    });
    return Array.from(categories);
  }

  getAllTags() {
    const tags = new Set();
    this.templates.forEach(template => {
      template.tags.forEach(tag => tags.add(tag));
    });
    return Array.from(tags);
  }
}

module.exports = FlowTemplateService;
